---
sidebar_position: 99
title: "DiamondCutFacet"
description: "Diamond upgrade (cut) facet for ERC-2535 diamonds"
gitSource: "https://github.com/maxnorm/Compose/blob/4f58223f08f652d9b72a6792643c40cac4f0f4a0/src/diamond/DiamondCutFacet.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Diamond upgrade (cut) facet for ERC-2535 diamonds
</DocSubtitle>

<Callout type="info" title="Key Features">
- Supports adding new facets and their functions to the diamond.
- Enables replacement of existing facet logic by updating function selectors.
- Allows for the removal of facets and their associated functions from the diamond.
- Provides access to the diamond's owner storage and the diamond's internal storage layout.
</Callout>

## Overview

The DiamondCutFacet provides the core upgrade mechanism for ERC-2535 compliant diamonds. It allows authorized addresses to add, replace, or remove functions (facets) from the diamond proxy, enabling dynamic modification of the diamond's capabilities. This facet is crucial for managing the diamond's evolving logic and feature set.

---

## Storage

### OwnerStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct OwnerStorage {
    address owner;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### DiamondStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
     * Array of all function selectors that can be called in the diamond
     */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetCut

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetCut {
    address facetAddress;
    FacetCutAction action;
    bytes4[] functionSelectors;
}`}
</ExpandableCode>

---
### State Variables

<PropertyTable
  properties={[
    {
      name: "OWNER_STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    },
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    }
  ]}
  showRequired={false}
/>

## Functions

### getOwnerStorage

Returns a pointer to the owner storage struct. Uses inline assembly to access the storage slot defined by STORAGE_POSITION.

<ExpandableCode language="solidity" maxLines={8}>
{`function getOwnerStorage() internal pure returns (OwnerStorage storage s);`}
</ExpandableCode>

**Returns:**

<PropertyTable
  properties={[
    {
      name: "s",
      type: "OwnerStorage",
      description: "The OwnerStorage struct in storage."
    }
  ]}
  showRequired={false}
/>

---
### getDiamondStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getDiamondStorage() internal pure returns (DiamondStorage storage s);`}
</ExpandableCode>

---
### addFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function addFunctions(address _facet, bytes4[] calldata _functionSelectors) internal;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[] calldata",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### replaceFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function replaceFunctions(address _facet, bytes4[] calldata _functionSelectors) internal;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[] calldata",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### removeFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function removeFunctions(address _facet, bytes4[] calldata _functionSelectors) internal;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[] calldata",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### diamondCut

Add/replace/remove any number of functions and optionally execute a function with delegatecall

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondCut(FacetCut[] calldata _diamondCut, address _init, bytes calldata _calldata) external;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_diamondCut",
      type: "FacetCut[]",
      description: "Contains the facet addresses and function selectors"
    },
    {
      name: "_init",
      type: "address",
      description: "The address of the contract or facet to execute _calldata"
    },
    {
      name: "_calldata",
      type: "bytes",
      description: "A function call, including function selector and arguments _calldata is executed with delegatecall on _init"
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="DiamondCut" defaultOpen={false}>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);`}
      </ExpandableCode>
    </div>

  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="OwnerUnauthorizedAccount" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error OwnerUnauthorizedAccount();
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoSelectorsProvidedForFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoSelectorsProvidedForFacet(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress, string _message);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="RemoveFacetAddressMustBeZeroAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error RemoveFacetAddressMustBeZeroAddress(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="IncorrectFacetCutAction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error IncorrectFacetCutAction(uint8 _action);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionThatDoesNotExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionThatDoesNotExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="InitializationFunctionReverted" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error InitializationFunctionReverted(address _initializationContractAddress, bytes _calldata);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {DiamondCutFacet} from "@compose/diamond/facets/DiamondCutFacet.sol";
import {IDiamondCut} from "@compose/diamond/interfaces/IDiamondCut.sol";

contract DeployDiamond {
    address constant DIAMOND_ADDRESS = address(0x1234567890abcdef); // Replace with your diamond address

    function upgradeDiamond() public {
        DiamondCutFacet diamondCutFacet = DiamondCutFacet(DIAMOND_ADDRESS);

        // Example: Add a new facet
        // Assume NewFacetABI is the ABI of the new facet contract
        // Assume newFacetAddress is the deployed address of the new facet
        // FunctionSelectors for the new facet functions are needed here
        // IDiamondCut.FacetCut[] memory cut = new IDiamondCut.FacetCut[](1);
        // cut[0] = IDiamondCut.FacetCut({
        //     facetAddress: newFacetAddress,
        //     action: IDiamondCut.FacetCutAction.ADD,
        //     functionSelectors: newFacetFunctionSelectors
        // });
        // diamondCutFacet.diamondCut(cut, address(0), "");
    }

    function replaceFacetLogic() public {
        // Example: Replace an existing facet
        // Assume ExistingFacetABI and existingFacetAddress are known
        // Assume selectorsToReplace are the selectors of functions to be replaced
        // IDiamondCut.FacetCut[] memory cut = new IDiamondCut.FacetCut[](1);
        // cut[0] = IDiamondCut.FacetCut({
        //     facetAddress: existingFacetAddress,
        //     action: IDiamondCut.FacetCutAction.REPLACE,
        //     functionSelectors: selectorsToReplace
        // });
        // diamondCutFacet.diamondCut(cut, address(0), "");
    }

    function removeFacet() public {
        // Example: Remove a facet
        // Assume selectorsToRemove are the selectors of functions to be removed
        // IDiamondCut.FacetCut[] memory cut = new IDiamondCut.FacetCut[](1);
        // cut[0] = IDiamondCut.FacetCut({
        //     facetAddress: address(0), // Address is ignored when removing
        //     action: IDiamondCut.FacetCutAction.REMOVE,
        //     functionSelectors: selectorsToRemove
        // });
        // diamondCutFacet.diamondCut(cut, address(0), "");
    }

    // Function to retrieve owner storage, requires knowledge of STORAGE_POSITION
    function getOwnerStoragePointer() public view returns (address) {
        return diamondCutFacet.getOwnerStorage();
    }
}`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure only authorized addresses can call `diamondCut` and its related functions. Access control should be managed externally or via another facet.
- Carefully construct `FacetCut` arrays to avoid unintended function removals or replacements. Audit selector lists before execution.
- Use `diamondCut` with caution, especially when replacing functions. Ensure new facet logic is compatible and thoroughly tested.
</Callout>

## Security Considerations

<Callout type="warning" title="Security">
The `diamondCut` function is a critical administrative function. Unauthorized access can lead to the complete compromise of the diamond's functionality. Implement robust access control mechanisms to restrict its usage. Reentrancy is not directly applicable to `diamondCut` itself, but any `delegatecall` executed via `diamondCut` must be carefully audited for reentrancy vulnerabilities.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondCutFacet" />
</div>

<LastUpdated date="2025-12-19T22:47:22.504Z" />
