---
sidebar_position: 99
title: "DiamondMod"
description: "Diamond Library - Internal functions and storage for diamond proxy functionality."
gitSource: "https://github.com/maxnorm/Compose/blob/7cec432f52f2cad53f4d546df90deb49e6a66d41/src/diamond/DiamondMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Diamond Library - Internal functions and storage for diamond proxy functionality.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Enables dynamic facet registration during initial deployment via &#x60;addFacets&#x60;.
- Provides a &#x60;diamondFallback&#x60; mechanism to route external calls to the appropriate facet.
- Exposes &#x60;getStorage&#x60; for retrieving the diamond&#x27;s internal storage layout.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

The DiamondMod library provides essential internal functions for managing diamond proxy facets and handling function calls. It is crucial for diamond deployment and runtime operation, enabling dynamic facet addition and robust fallback mechanisms for function execution.

---

## Storage

### FacetCutAction

Add&#x3D;0, Replace&#x3D;1, Remove&#x3D;2

---
### DiamondStorage

**Note:** storage-location: erc8042:compose.diamond

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
/**
 * \`selectors\` contains all function selectors that can be called in the diamond.
 */
bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
address facet;
uint32 position;
}`}
</ExpandableCode>

---
### FacetCut

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetCut {
address facetAddress;
FacetCutAction action;
bytes4[] functionSelectors;
}`}
</ExpandableCode>

Storage position: &#x60;DIAMOND_STORAGE_POSITION&#x60; - Used for diamond storage pattern.
---
### State Variables

<PropertyTable
  properties={[
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: " (Value: `keccak256(&quot;compose.diamond&quot;)`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### addFacets

Adds facets and their function selectors to the diamond. Only supports adding functions during diamond deployment.

<ExpandableCode language="solidity" maxLines={8}>
{`function addFacets(FacetCut[] memory _facets) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facets",
      type: "FacetCut[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### diamondFallback

Find facet for function that is called and execute the function if a facet is found and return any value.

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondFallback() ;`}
</ExpandableCode>

---
### getStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getStorage() pure returns (DiamondStorage storage s);`}
</ExpandableCode>

## Events

<AccordionGroup>
  <Accordion title="DiamondCut" defaultOpen={false}>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);`}
      </ExpandableCode>
    </div>

  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="FunctionNotFound" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error FunctionNotFound(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="InvalidActionWhenDeployingDiamond" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error InvalidActionWhenDeployingDiamond(address facetAddress, FacetCutAction action, bytes4[] functionSelectors);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress, string _message);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {DiamondMod} from "@compose/diamond-proxy/contracts/DiamondMod.sol";

contract MyFacet {
    DiamondMod internal diamondMod;

    constructor(address diamondModAddress) {
        diamondMod = DiamondMod(diamondModAddress);
    }

    /**
     * @notice Example of calling getStorage via DiamondMod.
     */
    function readDiamondStorage() external view returns (bytes memory) {
        return diamondMod.getStorage();
    }
}`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Use &#x60;addFacets&#x60; exclusively during diamond deployment to ensure deterministic facet registration.
- Implement custom errors or revert strings within facets to clearly indicate failures during &#x60;diamondFallback&#x60; execution.
- Ensure that &#x60;DiamondMod&#x60; is initialized correctly within the diamond proxy&#x27;s deployment or upgrade process.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
DiamondMod interacts directly with the diamond proxy&#x27;s storage. The &#x60;addFacets&#x60; function modifies the mapping of function selectors to facet addresses, which is fundamental to the diamond&#x27;s operation. &#x60;diamondFallback&#x60; relies on this mapping to dispatch calls. &#x60;getStorage&#x60; returns the raw storage data, which facets can interpret based on their own storage layouts.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondMod" />
</div>

<LastUpdated date="2025-12-19T21:23:54.434Z" />
