---
sidebar_position: 99
title: "DiamondMod"
description: "Diamond Library - Internal functions and storage for diamond proxy functionality."
gitSource: "https://github.com/maxnorm/Compose/blob/8fd3d0c28913baf3b948e02cb6af2111875ad106/src/diamond/DiamondMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Diamond Library - Internal functions and storage for diamond proxy functionality.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Facet Management: Enables adding facets and their associated function selectors to the diamond during deployment.
- Function Dispatch: Provides the fallback mechanism to route external calls to the correct facet implementation.
- Internal Storage Access: Offers a way to inspect diamond storage slots internally.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

DiamondMod provides core internal functions for managing diamond proxy facets and handling function calls. It is essential for the diamond's runtime logic, enabling facet registration and dispatch, crucial for composability and upgradeability within the Compose framework.

---

## Storage

### FacetCutAction

Add=0, Replace=1, Remove=2

---
### DiamondStorage

storage-location: erc8042:compose.diamond

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
/**
 * \`selectors\` contains all function selectors that can be called in the diamond.
 */
bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
address facet;
uint32 position;
}`}
</ExpandableCode>

---
### FacetCut

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetCut {
address facetAddress;
FacetCutAction action;
bytes4[] functionSelectors;
}`}
</ExpandableCode>

Storage position: `DIAMOND_STORAGE_POSITION` - Used for diamond storage pattern.
---
### State Variables

<PropertyTable
  properties={[
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(&quot;compose.diamond&quot;)`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### addFacets

Adds facets and their function selectors to the diamond. Only supports adding functions during diamond deployment.

<ExpandableCode language="solidity" maxLines={8}>
{`function addFacets(FacetCut[] memory _facets) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facets",
      type: "FacetCut[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### diamondFallback

Find facet for function that is called and execute the function if a facet is found and return any value.

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondFallback() ;`}
</ExpandableCode>

---
### getStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getStorage() pure returns (DiamondStorage storage s);`}
</ExpandableCode>

## Events

<AccordionGroup>
  <Accordion title="DiamondCut" defaultOpen={false}>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);`}
      </ExpandableCode>
    </div>

  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="FunctionNotFound" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error FunctionNotFound(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="InvalidActionWhenDeployingDiamond" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error InvalidActionWhenDeployingDiamond(address facetAddress, FacetCutAction action, bytes4[] functionSelectors);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress, string _message);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {IDiamondMod} from "@compose/diamond/contracts/diamond/IDiamondMod.sol";

contract ExampleFacet {
    IDiamondMod internal diamondMod;

    // Assume diamondMod is initialized elsewhere, e.g., during deployment
    constructor(address _diamondMod) {
        diamondMod = IDiamondMod(_diamondMod);
    }

    /**
     * @notice Example of interacting with diamondMod to get storage.
     * @dev This function is for demonstration purposes only.
     */
    function exampleGetStorage() external view returns (bytes32 storageValue) {
        // Example: retrieve a specific storage slot. Replace '0x...' with the actual slot.
        // Note: This is a simplified example; direct storage access should be done with caution.
        storageValue = diamondMod.getStorage(address(this), bytes32(uint256(0))); // Placeholder slot
        return storageValue;
    }
}`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Use `addFacets` only during initial diamond deployment to prevent runtime modification of the diamond's function-to-facet mappings.
- Ensure `diamondFallback` is correctly implemented and called by the diamond proxy to route calls to the appropriate facets.
- Access storage via `getStorage` with caution, understanding that storage layout and slot allocation are critical for diamond integrity.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
DiamondMod interacts directly with the diamond proxy's storage. The `addFacets` function is intended for initial deployment only and modifies the internal mapping of function selectors to facet addresses. `diamondFallback` acts as the central dispatcher, looking up the facet for a given function selector and executing it. `getStorage` allows internal access to the diamond's storage slots. Changes made via `addFacets` are persistent and define the diamond's runtime behavior.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondMod" />
</div>

<LastUpdated date="2025-12-19T22:26:26.368Z" />
