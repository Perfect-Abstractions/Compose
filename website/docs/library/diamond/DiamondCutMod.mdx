---
sidebar_position: 99
title: "DiamondCutMod"
description: "Manages diamond facet additions, replacements, and removals."
gitSource: "https://github.com/maxnorm/Compose/blob/5736454575f67743dd05ba6cb1265bc06d0c1422/src/diamond/DiamondCutMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Manages diamond facet additions, replacements, and removals.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Atomically adds, replaces, or removes multiple functions in a single transaction.
- Supports optional delegatecall execution of an initialization function after the cut.
- Enforces restrictions against modifying immutable functions and prevents redundant operations.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

The DiamondCutMod provides essential functions for managing the facets of a Compose diamond. It allows for controlled addition, replacement, and removal of functions, ensuring the diamond's logic can be upgraded and extended safely. This module is critical for maintaining the diamond's integrity during upgrades.

---

## Storage

### FacetCutAction

Add=0, Replace=1, Remove=2

---
### DiamondStorage

storage-location: erc8042:compose.diamond

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
    * Array of all function selectors that can be called in the diamond
    */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### FacetCut

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetCut {
    address facetAddress;
    FacetCutAction action;
    bytes4[] functionSelectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"compose.diamond\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### addFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function addFunctions(address _facet, bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### diamondCut

Add/replace/remove any number of functions and optionally execute a function with delegatecall

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondCut(FacetCut[] calldata _diamondCut, address _init, bytes calldata _calldata) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_diamondCut",
      type: "FacetCut[]",
      description: "Contains the facet addresses and function selectors"
    },
    {
      name: "_init",
      type: "address",
      description: "The address of the contract or facet to execute _calldata"
    },
    {
      name: "_calldata",
      type: "bytes",
      description: "A function call, including function selector and arguments _calldata is executed with delegatecall on _init"
    }
  ]}
  showRequired={false}
/>

---
### getStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getStorage() pure returns (DiamondStorage storage s);`}
</ExpandableCode>

---
### removeFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function removeFunctions(address _facet, bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### replaceFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function replaceFunctions(address _facet, bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="DiamondCut" defaultOpen={false}>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);`}
      </ExpandableCode>
    </div>

  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionThatDoesNotExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionThatDoesNotExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="IncorrectFacetCutAction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error IncorrectFacetCutAction(uint8 _action);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="InitializationFunctionReverted" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error InitializationFunctionReverted(address _initializationContractAddress, bytes _calldata);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress, string _message);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoSelectorsProvidedForFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoSelectorsProvidedForFacet(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="RemoveFacetAddressMustBeZeroAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error RemoveFacetAddressMustBeZeroAddress(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {IDiamondCut} from "@compose-protocol/diamond-contracts/contracts/facets/DiamondCutMod.sol";

contract MyFacet {
    // ... other facet logic ...

    function upgradeDiamond(address _diamondAddress) external {
        address[] memory facetAddresses = new address[](1);
        facetAddresses[0] = address(this); // Assuming this contract is the new facet

        bytes[] memory functionSigs = new bytes[](1);
        functionSigs[0] = bytes4(keccak256(\"myNewFunction(uint256)\")); // Example selector

        IDiamondCut(_diamondAddress).diamondCut(facetAddresses, address(0), functionSigs, address(0), \"\");
    }

    // ... other facet logic ...
}`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Use `diamondCut` carefully; ensure all function selectors are correctly identified to avoid unintended logic changes or access control bypasses.
- Always verify that the facet addresses provided are deployed and contain the intended bytecode before executing `diamondCut`.
- Handle potential `InitializationFunctionReverted` errors by ensuring any initialization logic within the cut is robust and correctly implemented.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
The DiamondCutMod directly manipulates the diamond's function selector to facet address mapping. Any changes made via `diamondCut` are immediately reflected in the diamond proxy's routing logic. Facets interact with this module by calling its external functions, typically during upgrade processes. The `DiamondCut` event is emitted upon successful completion of a diamond cut operation, providing an audit trail of changes.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondCutMod" />
</div>

<LastUpdated date="2025-12-21T22:06:20.158Z" />
