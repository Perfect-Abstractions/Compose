---
sidebar_position: 99
title: "DiamondCutFacet"
description: "Manage diamond facets and functions programmatically."
gitSource: "https://github.com/maxnorm/Compose/blob/75e2e68f9cd44e6a24767abe937e3f91886c823f/src/diamond/DiamondCutFacet.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Manage diamond facets and functions programmatically.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Supports adding, replacing, and removing functions and entire facets.
- Allows for optional execution of an initialization function during a cut operation.
- Provides granular control over the diamond's functional surface area.
</Callout>

## Overview

The DiamondCutFacet provides the essential on-chain mechanism for upgrading and managing the functional surface area of a Compose diamond. It allows for the addition, replacement, and removal of functions across various facets, ensuring the diamond's capabilities can evolve over time. This facet is crucial for maintaining and extending the diamond's functionality post-deployment.

---

## Storage

### OwnerStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct OwnerStorage {
    address owner;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### DiamondStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
     * Array of all function selectors that can be called in the diamond
     */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetCut

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetCut {
    address facetAddress;
    FacetCutAction action;
    bytes4[] functionSelectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "OWNER_STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    },
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    }
  ]}
  showRequired={false}
/>

## Functions

### getOwnerStorage

Returns a pointer to the owner storage struct. Uses inline assembly to access the storage slot defined by STORAGE_POSITION.

<ExpandableCode language="solidity" maxLines={8}>
{`function getOwnerStorage() internal pure returns (OwnerStorage storage s);`}
</ExpandableCode>

**Returns:**

<PropertyTable
  properties={[
    {
      name: "s",
      type: "OwnerStorage",
      description: "The OwnerStorage struct in storage."
    }
  ]}
  showRequired={false}
/>

---
### getDiamondStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getDiamondStorage() internal pure returns (DiamondStorage storage s);`}
</ExpandableCode>

---
### addFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function addFunctions(address _facet, bytes4[] calldata _functionSelectors) internal;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[] calldata",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### replaceFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function replaceFunctions(address _facet, bytes4[] calldata _functionSelectors) internal;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[] calldata",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### removeFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function removeFunctions(address _facet, bytes4[] calldata _functionSelectors) internal;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[] calldata",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### diamondCut

Add/replace/remove any number of functions and optionally execute a function with delegatecall

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondCut(FacetCut[] calldata _diamondCut, address _init, bytes calldata _calldata) external;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_diamondCut",
      type: "FacetCut[]",
      description: "Contains the facet addresses and function selectors"
    },
    {
      name: "_init",
      type: "address",
      description: "The address of the contract or facet to execute _calldata"
    },
    {
      name: "_calldata",
      type: "bytes",
      description: "A function call, including function selector and arguments _calldata is executed with delegatecall on _init"
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="DiamondCut" defaultOpen={false}>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);`}
      </ExpandableCode>
    </div>

  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="OwnerUnauthorizedAccount" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error OwnerUnauthorizedAccount();
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoSelectorsProvidedForFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoSelectorsProvidedForFacet(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress, string _message);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="RemoveFacetAddressMustBeZeroAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error RemoveFacetAddressMustBeZeroAddress(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="IncorrectFacetCutAction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error IncorrectFacetCutAction(uint8 _action);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionThatDoesNotExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionThatDoesNotExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="InitializationFunctionReverted" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error InitializationFunctionReverted(address _initializationContractAddress, bytes _calldata);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {IDiamondCut} from "@compose/contracts/facets/DiamondCut/IDiamondCut.sol";

contract Deployer {
    // Assume diamondAddress is the address of your deployed diamond proxy
    address diamondAddress;

    function upgradeDiamond() external {
        // Get the DiamondCutFacet interface
        IDiamondCut diamondCutFacet = IDiamondCut(diamondAddress);

        // Define facet cut data
        // Example: Add a new ERC721 facet
        address newErc721FacetAddress = address(0x123...); // Address of the deployed ERC721 facet contract
        bytes4[] memory erc721Selectors = new bytes4[](2);
        erc721Selectors[0] = IDiamondCut.getOwnerStorage.selector; // Example selector
        erc721Selectors[1] = IDiamondCut.getDiamondStorage.selector; // Example selector

        // Execute the diamond cut
        // Note: The owner must have permissions to call diamondCut
        diamondCutFacet.diamondCut(
            new IDiamondCut.FacetCut[](0), // No facets to remove
            new IDiamondCut.FacetCut[](1){ \
                facetAddress: newErc721FacetAddress,
                action: IDiamondCut.FacetCutAction.ADD,
                selectors: erc721Selectors
            },
            address(0), // No init function to call
            bytes("") // No init data
        );
    }
}`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure the caller has the necessary permissions (e.g., owner role) before invoking `diamondCut`.
- Carefully manage facet addresses and selector mappings to prevent unintended function overwrites or removals.
- Store facet deployment addresses off-chain or in a trusted registry for secure upgrades.
</Callout>

## Security Considerations

<Callout type="warning" title="Security">
The `diamondCut` function is highly sensitive and should only be callable by authorized addresses. Incorrect usage can lead to loss of functionality or unintended state changes. Ensure all function selectors are correctly mapped to their corresponding facet addresses. Be cautious when replacing existing functions, especially immutable ones, as this can break existing integrations. Initialization functions executed during `diamondCut` must be carefully audited for reentrancy and other vulnerabilities.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondCutFacet" />
</div>

<LastUpdated date="2025-12-21T20:55:35.841Z" />
