---
sidebar_position: 3
title: "DiamondCutFacet"
description: "Manage diamond facet additions, replacements, and removals."
gitSource: "https://github.com/Perfect-Abstractions/Compose/tree/main/src/diamond/DiamondCutFacet.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Manage diamond facet additions, replacements, and removals.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Supports adding new facets to the diamond proxy.
- Enables replacing existing facet functions with new implementations.
- Allows for the removal of functions from the diamond's routing.
- Can optionally execute an initialization function after the cut.
</Callout>

## Overview

The DiamondCutFacet provides the core functionality for upgrading a diamond proxy. It allows for the addition, replacement, and removal of functions (facets) within the diamond, enabling dynamic contract logic updates and extensions.

---

## Storage

### OwnerStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct OwnerStorage {
    address owner;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### DiamondStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
    * Array of all function selectors that can be called in the diamond
    */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetCut

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetCut {
    address facetAddress;
    FacetCutAction action;
    bytes4[] functionSelectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "OWNER_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"compose.owner\")`)"
    },
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"compose.diamond\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### diamondCut

Add/replace/remove any number of functions and optionally execute a function with delegatecall

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondCut(FacetCut[] calldata _diamondCut, address _init, bytes calldata _calldata) external;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_diamondCut",
      type: "FacetCut[]",
      description: "Contains the facet addresses and function selectors"
    },
    {
      name: "_init",
      type: "address",
      description: "The address of the contract or facet to execute _calldata"
    },
    {
      name: "_calldata",
      type: "bytes",
      description: "A function call, including function selector and arguments _calldata is executed with delegatecall on _init"
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="DiamondCut" defaultOpen={false}>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);`}
      </ExpandableCode>
    </div>

  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="OwnerUnauthorizedAccount" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error OwnerUnauthorizedAccount();
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoSelectorsProvidedForFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoSelectorsProvidedForFacet(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress, string _message);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="RemoveFacetAddressMustBeZeroAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error RemoveFacetAddressMustBeZeroAddress(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="IncorrectFacetCutAction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error IncorrectFacetCutAction(uint8 _action);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionWithTheSameFunctionFromTheSameFacet(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionThatDoesNotExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionThatDoesNotExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="InitializationFunctionReverted" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error InitializationFunctionReverted(address _initializationContractAddress, bytes _calldata);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {IDiamondCut} from "@compose/diamond/contracts/facets/DiamondCutFacet.sol";

contract MyDiamond {
    // Assume DiamondProxy is deployed with DiamondCutFacet
    IDiamondCut internal diamondCutFacet;

    constructor(address _diamondProxyAddress) {
        diamondCutFacet = IDiamondCut(_diamondProxyAddress);
    }

    function upgradeDiamond() external {
        // Example: Add a new facet
        address newFacetAddress = address(0x123...); // Address of the new facet contract
        bytes4[] memory functionsToAdd = new bytes4[](1);
        functionsToAdd[0] = this.newFunction.selector; // Selector for a function in the new facet

        // Example: Replace an existing facet's function
        address existingFacetAddress = address(0x456...); // Address of the existing facet contract
        bytes4[] memory functionsToReplace = new bytes4[](1);
        functionsToReplace[0] = this.oldFunction.selector; // Selector for a function in the existing facet

        // Example: Remove a facet's function
        address facetToRemoveFromAddress = address(0x789...); // Address of the facet to remove function from
        bytes4[] memory functionsToRemove = new bytes4[](1);
        functionsToRemove[0] = this.deprecatedFunction.selector; // Selector for a function to remove

        // Construct the diamond cut data
        IDiamondCut.FacetCut[] memory cuts = new IDiamondCut.FacetCut[](3);

        cuts[0] = IDiamondCut.FacetCut({
            facetAddress: newFacetAddress,
            action: IDiamondCut.FacetAction.Add,
            functionSelectors: functionsToAdd
        });

        cuts[1] = IDiamondCut.FacetCut({
            facetAddress: existingFacetAddress,
            action: IDiamondCut.FacetAction.Replace,
            functionSelectors: functionsToReplace
        });

        cuts[2] = IDiamondCut.FacetCut({
            facetAddress: facetToRemoveFromAddress,
            action: IDiamondCut.FacetAction.Remove,
            functionSelectors: functionsToRemove
        });

        // Execute the diamond cut
        // The owner of the diamond must have permissions to call this
        diamondCutFacet.diamondCut(cuts, address(0), "");
    }

    // Dummy functions for example selectors
    function newFunction() external pure returns (uint256) { return 0; }
    function oldFunction() external pure returns (uint256) { return 0; }
    function deprecatedFunction() external pure returns (uint256) { return 0; }
}`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure the caller has the necessary ownership or administrative role to execute `diamondCut`.
- Carefully review the `FacetCut` actions (Add, Replace, Remove) and associated function selectors before execution to prevent unintended logic changes.
- Always provide a valid `facetAddress` for Add and Replace actions, and zero address for Remove actions as per EIP-2535.
</Callout>

## Security Considerations

<Callout type="warning" title="Security">
Access to `diamondCut` must be strictly controlled, typically by an owner or a dedicated role, to prevent unauthorized upgrades. Incorrectly specifying facet addresses or function selectors can lead to broken functionality or security vulnerabilities. Ensure that replaced or removed functions are not critical for existing operations or that alternative logic is in place. Reentrancy is not a direct concern for the `diamondCut` function itself, but any initialization function called via `diamondCut` must be guarded against reentrancy if it modifies sensitive state.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <RelatedDocs
    items={[
      {
        title: "DiamondCutMod",
        href: "/docs/library/diamond",
        description: "Module used by DiamondCutFacet",
        icon: "ðŸ“¦"
      },
      {
        title: "DiamondInspectFacet",
        href: "/docs/library/diamond",
        description: "Related facet in diamond",
        icon: "ðŸ’Ž"
      },
      {
        title: "ExampleDiamond",
        href: "/docs/library/diamond/example",
        description: "Related facet in diamond",
        icon: "ðŸ’Ž"
      }
    ]}
  />
</div>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondCutFacet" />
</div>

<LastUpdated date="2025-12-28T04:49:17.725Z" />
