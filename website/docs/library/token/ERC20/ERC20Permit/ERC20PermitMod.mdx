---
sidebar_position: 99
title: "ERC20PermitMod"
description: "Implement ERC-2612 permit functionality for ERC-20 tokens."
gitSource: "https://github.com/maxnorm/Compose/blob/2dfa9eb69851162421010a7e56bd0fa891a9311a/src/token/ERC20/ERC20Permit/ERC20PermitMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Implement ERC-2612 permit functionality for ERC-20 tokens.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Implements EIP-2612 Permit functionality for ERC-20 tokens.
- Provides a reusable library for domain separator generation and signature verification.
- Isolates complex signature logic, enabling cleaner facet implementations.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

This module provides the core logic and storage for implementing the ERC-2612 Permit functionality. It allows users to grant token allowances via signed messages, enhancing gas efficiency and user experience. By isolating this logic, facets can easily integrate permit capabilities without duplicating complex signature verification and allowance setting code.

---

## Storage

### ERC20PermitStorage

storage-location: erc8042:compose.erc20.permit

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct ERC20PermitStorage {
mapping(address owner => uint256) nonces;
}`}
</ExpandableCode>

---
### ERC20Storage

storage-location: erc8042:compose.erc20

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct ERC20Storage {
mapping(address owner => uint256 balance) balanceOf;
uint256 totalSupply;
mapping(address owner => mapping(address spender => uint256 allowance)) allowance;
uint8 decimals;
string name;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "ERC20_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"compose.erc20\")`)"
    },
    {
      name: "STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"compose.erc20.permit\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### DOMAIN_SEPARATOR

Returns the domain separator used in the encoding of the signature for &#123;permit&#125;. This value is unique to a contract and chain ID combination to prevent replay attacks.

<ExpandableCode language="solidity" maxLines={8}>
{`function DOMAIN_SEPARATOR() view returns (bytes32);`}
</ExpandableCode>

**Returns:**

<PropertyTable
  properties={[
    {
      name: "-",
      type: "bytes32",
      description: "The domain separator."
    }
  ]}
  showRequired={false}
/>

---
### getERC20Storage

<ExpandableCode language="solidity" maxLines={8}>
{`function getERC20Storage() pure returns (ERC20Storage storage s);`}
</ExpandableCode>

---
### getPermitStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getPermitStorage() pure returns (ERC20PermitStorage storage s);`}
</ExpandableCode>

---
### permit

Validates a permit signature and sets allowance. Emits Approval event; must be emitted by the calling facet/contract.

<ExpandableCode language="solidity" maxLines={8}>
{`function permit(address _owner, address _spender, uint256 _value, uint256 _deadline, uint8 _v, bytes32 _r, bytes32 _s) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_owner",
      type: "address",
      description: "Token owner."
    },
    {
      name: "_spender",
      type: "address",
      description: "Token spender."
    },
    {
      name: "_value",
      type: "uint256",
      description: "Allowance value."
    },
    {
      name: "_deadline",
      type: "uint256",
      description: "Permit\&#x27;s time deadline."
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="Approval" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when an approval is made for a spender by an owner.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event Approval(address indexed _owner, address indexed _spender, uint256 _value);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_owner",
            type: "address",
            description: "The address granting the allowance."
          },
          {
            name: "_spender",
            type: "address",
            description: "The address receiving the allowance."
          },
          {
            name: "_value",
            type: "uint256",
            description: "The amount approved."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="ERC20InvalidSpender" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Thrown when the spender address is invalid (e.g., zero address).
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error ERC20InvalidSpender(address _spender);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="ERC2612InvalidSignature" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Thrown when a permit signature is invalid or expired.
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error ERC2612InvalidSignature(
address _owner, address _spender, uint256 _value, uint256 _deadline, uint8 _v, bytes32 _r, bytes32 _s
);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {IERC20PermitMod, IERC20PermitStorage} from "@compose/modules/erc20/ERC20PermitMod.sol";

contract MyERC20Facet {
    // Assume ERC20PermitMod is deployed and its address is known
    address immutable erc20PermitModAddress;

    constructor(address _erc20PermitModAddress) {
        erc20PermitModAddress = _erc20PermitModAddress;
    }

    /**
     * @notice Allows a user to permit an operator by signing a permit message.
     * @param _owner The owner of the tokens.
     * @param _spender The address to grant allowance to.
     * @param _value The amount of tokens to allow.
     * @param _deadline The timestamp after which the permit is invalid.
     * @param _v The v component of the signature.
     * @param _r The r component of the signature.
     * @param _s The s component of the signature.
     */
    function permit(address _owner, address _spender, uint256 _value, uint256 _deadline, uint8 _v, bytes32 _r, bytes32 _s) external {
        // Call the module's permit function. The module will handle signature validation
        // and setting the allowance. The Approval event MUST be emitted by the calling facet.
        (bool success, bytes memory data) = erc20PermitModAddress.call(abi.encodeWithSelector(IERC20PermitMod.permit.selector, _owner, _spender, _value, _deadline, _v, _r, _s));
        require(success, "ERC20PermitMod: permit call failed");

        // Emit the Approval event as required by ERC-20 and ERC-2612
        emit Approval(_owner, _spender, _value);
    }

    // Other ERC-20 functions...
}
`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure the `permit` function in your facet emits the `Approval` event after a successful call to the module, as required by the ERC-2612 standard.
- Validate the `_deadline` parameter to prevent the use of stale permits.
- Implement appropriate access control for the `permit` function if necessary, though it is typically permissionless.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
This module requires access to specific storage slots for ERC-20 token data and permit-specific data. The `getERC20Storage` and `getPermitStorage` functions are internal helpers to access these slots. Facets integrating this module must ensure that their storage layout is compatible or that they correctly delegate to this module's storage access. The `permit` function in the calling facet must emit the `Approval` event to adhere to ERC-20 and ERC-2612 standards.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="ERC20PermitMod" />
</div>

<LastUpdated date="2025-12-21T21:44:01.583Z" />
