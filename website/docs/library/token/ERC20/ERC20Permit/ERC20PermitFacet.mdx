---
sidebar_position: 99
title: "ERC20PermitFacet"
description: "Enables EIP-2612 permit functionality for ERC-20 tokens."
gitSource: "https://github.com/maxnorm/Compose/blob/5736454575f67743dd05ba6cb1265bc06d0c1422/src/token/ERC20/ERC20Permit/ERC20PermitFacet.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Enables EIP-2612 permit functionality for ERC-20 tokens.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Implements EIP-2612 permit functionality for ERC-20 tokens.
- Allows token owners to grant allowances via signed messages.
- Reduces transaction overhead by enabling off-chain signature generation.
- Provides functions to retrieve nonces and the domain separator for signature construction.
</Callout>

## Overview

The ERC20PermitFacet integrates EIP-2612's permit functionality into a Compose diamond. It allows token owners to grant allowances to spenders via a signed message, removing the need for an explicit `approve` transaction. This enhances user experience by reducing transaction costs and improving efficiency.

---

## Storage

### ERC20Storage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct ERC20Storage {
    mapping(address owner => uint256 balance) balanceOf;
    uint256 totalSupply;
    mapping(address owner => mapping(address spender => uint256 allowance)) allowance;
    uint8 decimals;
    string name;
}`}
</ExpandableCode>

---
### ERC20PermitStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct ERC20PermitStorage {
    mapping(address owner => uint256) nonces;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "ERC20_STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    },
    {
      name: "STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    }
  ]}
  showRequired={false}
/>

## Functions

### getERC20Storage

<ExpandableCode language="solidity" maxLines={8}>
{`function getERC20Storage() internal pure returns (ERC20Storage storage s);`}
</ExpandableCode>

---
### getStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getStorage() internal pure returns (ERC20PermitStorage storage s);`}
</ExpandableCode>

---
### nonces

Returns the current nonce for an owner. This value changes each time a permit is used.

<ExpandableCode language="solidity" maxLines={8}>
{`function nonces(address _owner) external view returns (uint256);`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_owner",
      type: "address",
      description: "The address of the owner."
    }
  ]}
  showRequired={false}
/>

**Returns:**

<PropertyTable
  properties={[
    {
      name: "-",
      type: "uint256",
      description: "The current nonce."
    }
  ]}
  showRequired={false}
/>

---
### DOMAIN_SEPARATOR

Returns the domain separator used in the encoding of the signature for permit. This value is unique to a contract and chain ID combination to prevent replay attacks.

<ExpandableCode language="solidity" maxLines={8}>
{`function DOMAIN_SEPARATOR() external view returns (bytes32);`}
</ExpandableCode>

**Returns:**

<PropertyTable
  properties={[
    {
      name: "-",
      type: "bytes32",
      description: "The domain separator."
    }
  ]}
  showRequired={false}
/>

---
### permit

Sets the allowance for a spender via a signature. This function implements EIP-2612 permit functionality.

<ExpandableCode language="solidity" maxLines={8}>
{`function permit(
    address _owner,
    address _spender,
    uint256 _value,
    uint256 _deadline,
    uint8 _v,
    bytes32 _r,
    bytes32 _s
) external;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_owner",
      type: "address",
      description: "The address of the token owner."
    },
    {
      name: "_spender",
      type: "address",
      description: "The address of the spender."
    },
    {
      name: "_value",
      type: "uint256",
      description: "The amount of tokens to approve."
    },
    {
      name: "_deadline",
      type: "uint256",
      description: "The deadline for the permit (timestamp)."
    },
    {
      name: "_v",
      type: "uint8",
      description: "The recovery byte of the signature."
    },
    {
      name: "_r",
      type: "bytes32",
      description: "The r value of the signature."
    },
    {
      name: "_s",
      type: "bytes32",
      description: "The s value of the signature."
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="Approval" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when an approval is made for a spender by an owner.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event Approval(address indexed _owner, address indexed _spender, uint256 _value);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_owner",
            type: "address",
            description: "The address granting the allowance."
          },
          {
            name: "_spender",
            type: "address",
            description: "The address receiving the allowance."
          },
          {
            name: "_value",
            type: "uint256",
            description: "The amount approved."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="ERC2612InvalidSignature" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Thrown when a permit signature is invalid or expired.
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error ERC2612InvalidSignature(
    address _owner, address _spender, uint256 _value, uint256 _deadline, uint8 _v, bytes32 _r, bytes32 _s
);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="ERC20InvalidSpender" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Thrown when the spender address is invalid (e.g., zero address).
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error ERC20InvalidSpender(address _spender);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {IERC20Permit} from "@openzeppelin/contracts/token/ERC20/extensions/draft-IERC20Permit.sol";
import {DiamondInterface} from "@compose-protocol/diamond-interface/DiamondInterface.sol";

contract ERC20PermitConsumer {
    DiamondInterface public diamond;

    constructor(address _diamondAddress) {
        diamond = DiamondInterface(_diamondAddress);
    }

    /**
     * @notice Get the current nonce for a given owner.
     * @param _owner The address of the token owner.
     * @return The current nonce.
     */
    function getUserNonce(address _owner) external view returns (uint256) {
        // The selector for nonces function from ERC20PermitFacet
        bytes4 selector = bytes4(keccak256("nonces(address)"));
        return abi.decode(diamond.callStatic(selector, abi.encode(_owner)), (uint256));
    }

    /**
     * @notice Set an allowance using EIP-2612 permit.
     * @param _owner The address of the token owner.
     * @param _spender The address to grant allowance to.
     * @param _value The amount to allow.
     * @param _deadline The permit deadline.
     * @param _v The signature v component.
     * @param _r The signature r component.
     * @param _s The signature s component.
     */
    function permitToken(address _owner, address _spender, uint256 _value, uint256 _deadline, uint8 _v, bytes32 _r, bytes32 _s) external {
        // The selector for permit function from ERC20PermitFacet
        bytes4 selector = bytes4(keccak256("permit(address,address,uint256,uint256,uint8,bytes32,bytes32)"));
        diamond.execute(selector, abi.encode(_owner, _spender, _value, _deadline, _v, _r, _s));
    }
}`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure the ERC20PermitFacet is correctly initialized with the appropriate domain separator and chain ID during diamond deployment.
- Validate the permit deadline to prevent expired permits from being used.
- Use the `nonces` function to track the usage of permits and prevent replay attacks.
</Callout>

## Security Considerations

<Callout type="warning" title="Security">
This facet implements EIP-2612, which relies on cryptographic signatures. Ensure that the signature verification process is robust and that the domain separator is correctly configured to prevent replay attacks across different contracts or chains. Input validation on `_deadline` is crucial to prevent the use of expired permits.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="ERC20PermitFacet" />
</div>

<LastUpdated date="2025-12-21T22:05:01.030Z" />
